<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Class Performance</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header class="header">
    <div class="header-content">
        <div class="school-name">
            <i class="fas fa-school"></i>
            <span>Primary School Management System</span>
        </div>
    </div>
</header>

<div class="nav-container">

    <!-- Sidebar -->
    <nav class="sidebar">
        <ul class="sidebar-menu">
            <li><a th:href="@{/}"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
            <li><a th:href="@{/students}"><i class="fas fa-user-graduate"></i><span>Students</span></a></li>
            <li><a th:href="@{/teachers}"><i class="fas fa-chalkboard-teacher"></i><span>Teachers</span></a></li>
            <li><a th:href="@{/classes}"><i class="fas fa-door-open"></i><span>Classes</span></a></li>
            <li><a th:href="@{/subjects}"><i class="fas fa-book"></i><span>Subjects</span></a></li>
            <li><a th:href="@{/performance}" class="active"><i class="fas fa-chart-line"></i><span>Performance</span></a></li>
            <li><a th:href="@{/reports}"><i class="fas fa-file-alt"></i><span>Reports</span></a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">

            <div class="page-header">
                <h1 class="page-title">Class Performance</h1>
                <a th:href="@{/performance}" class="btn btn-secondary">Back</a>
            </div>

            <div class="card">

                <!-- Filter Form -->
                <form th:action="@{/performance/class}" method="get" class="mb-3">
                    <div class="form-row">

                        <div class="form-group">
                            <label class="form-label">Select Class *</label>
                            <select name="classId" class="form-control" onchange="this.form.submit()">
                                <option value="">-- Select Class --</option>
                                <option th:each="cls : ${classes}"
                                        th:value="${cls.id}"
                                        th:text="${cls.className}"
                                        th:selected="${selectedClass != null && selectedClass.id == cls.id}">
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Term *</label>
                            <select name="term" class="form-control" onchange="this.form.submit()">
                                <option value="Term 1" th:selected="${term == 'Term 1'}">Term 1</option>
                                <option value="Term 2" th:selected="${term == 'Term 2'}">Term 2</option>
                                <option value="Term 3" th:selected="${term == 'Term 3'}">Term 3</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Year *</label>
                            <select name="year" class="form-control" onchange="this.form.submit()">
                                <option th:each="yr : ${years}"
                                        th:value="${yr}"
                                        th:text="${yr}"
                                        th:selected="${yr == year}">
                                </option>
                            </select>
                        </div>

                    </div>
                </form>

                <!-- Results Section -->
                <div th:if="${selectedClass != null && studentResults != null}" class="mt-3">

                    <h3 class="mb-3">
                        Performance Results:
                        <span th:text="${selectedClass.className}"></span> -
                        <span th:text="${term}"></span>,
                        <span th:text="${year}"></span>
                    </h3>

                    <!-- Summary Badges -->
                    <div class="mb-3" th:if="${!#lists.isEmpty(studentResults)}">
                        <span class="badge badge-info" style="font-size:14px;padding:8px;">
                            <i class="fas fa-calculator"></i>
                            Class Mean Score:
                            <span th:text="${meanScore}">75.5</span>
                        </span>

                        <span class="badge badge-secondary" style="font-size:14px;padding:8px;margin-left:10px;">
                            <i class="fas fa-users"></i>
                            Students:
                            <span th:text="${#lists.size(studentResults)}">30</span>
                        </span>
                    </div>

                    <!-- Results Table -->
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Position</th>
                            <th>Student Name</th>
                            <th>Adm No</th>
                            <th>Total Marks</th>
                            <th>Best 4 Aggregate</th>
                            <th>Division</th>
                        </tr>
                        </thead>
                        <tbody>

                        <tr th:each="result, stat : ${studentResults}">

                            <!-- Position -->
                            <td>
                                <span th:if="${stat.index == 0}" class="badge badge-gold">1st</span>
                                <span th:if="${stat.index == 1}" class="badge badge-silver">2nd</span>
                                <span th:if="${stat.index == 2}" class="badge badge-bronze">3rd</span>
                                <span th:if="${stat.index > 2}" th:text="${stat.index + 1}"></span>
                            </td>

                            <!-- Student Info -->
                            <td th:text="${result.student.firstName + ' ' + result.student.lastName}"></td>
                            <td th:text="${result.student.admissionNumber}"></td>

                            <!-- Marks -->
                            <td th:text="${result.totalMarks}"></td>
                            <td th:text="${result.best4Aggregate}"></td>

                            <!-- Division (FIXED using th:switch) -->
                            <td>
                                <span th:switch="${result.division}">
                                    <span th:case="'I'" class="badge badge-success">I</span>
                                    <span th:case="'II'" class="badge badge-info">II</span>
                                    <span th:case="'III'" class="badge badge-warning">III</span>
                                    <span th:case="*"
                                          class="badge badge-danger"
                                          th:text="${result.division}">IV</span>
                                </span>
                            </td>

                        </tr>

                        <tr th:if="${#lists.isEmpty(studentResults)}">
                            <td colspan="6" class="text-center">No results found</td>
                        </tr>

                        </tbody>
                    </table>

                    <!-- Top 3 Performers -->
                    <div th:if="${!#lists.isEmpty(studentResults)}" class="mt-3">
                        <h4>Top 3 Performers</h4>

                        <div class="stats-grid">

                            <div th:if="${studentResults.size() > 0}" class="stat-card">
                                <i class="fas fa-trophy stat-icon gold"></i>
                                <div class="stat-info">
                                    <h4>1st</h4>
                                    <p th:text="${studentResults[0].student.firstName + ' ' + studentResults[0].student.lastName}"></p>
                                    <p th:text="${'Total: ' + studentResults[0].totalMarks}"></p>
                                </div>
                            </div>

                            <div th:if="${studentResults.size() > 1}" class="stat-card">
                                <i class="fas fa-medal stat-icon silver"></i>
                                <div class="stat-info">
                                    <h4>2nd</h4>
                                    <p th:text="${studentResults[1].student.firstName + ' ' + studentResults[1].student.lastName}"></p>
                                    <p th:text="${'Total: ' + studentResults[1].totalMarks}"></p>
                                </div>
                            </div>

                            <div th:if="${studentResults.size() > 2}" class="stat-card">
                                <i class="fas fa-award stat-icon bronze"></i>
                                <div class="stat-info">
                                    <h4>3rd</h4>
                                    <p th:text="${studentResults[2].student.firstName + ' ' + studentResults[2].student.lastName}"></p>
                                    <p th:text="${'Total: ' + studentResults[2].totalMarks}"></p>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>

            </div>
        </div>
    </main>
</div>

<footer class="footer">
    <p>&copy; 2026 Primary School Management System. All Rights Reserved.</p>
</footer>

</body>
</html>